name: Build Windows Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version_bump:
        description: 'ÁâàÊú¨ÈÄíÂ¢ûÁ±ªÂûãÔºànone = ‰ªÖÊûÑÂª∫‰∏çÂèëÂ∏ÉÔºâ'
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
          - none
        default: patch
      create_release:
        description: 'ÊòØÂê¶ÂàõÂª∫ GitHub ReleaseÔºà‰ªÖ version_bump Èùû none Êó∂ÁîüÊïàÔºâ'
        required: true
        type: boolean
        default: true

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag: ${{ steps.version.outputs.tag }}
      create_release: ${{ github.event_name == 'push' || (github.event.inputs.version_bump != 'none' && github.event.inputs.create_release == 'true') }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version and create tag
        id: version
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "push" ]; then
            # tag push: ‰ªé ref ‰∏≠ÊèêÂèñ
            TAG_NAME=${GITHUB_REF#refs/tags/}
            VERSION=${TAG_NAME#v}
          else
            BUMP="${{ github.event.inputs.version_bump }}"

            if [ "$BUMP" = "none" ]; then
              # ‰ªÖÊûÑÂª∫Ôºå‰∏çÂàõÂª∫ tag
              SHORT_SHA=$(git rev-parse --short HEAD)
              echo "tag=" >> $GITHUB_OUTPUT
              echo "version=dev-$SHORT_SHA" >> $GITHUB_OUTPUT
              echo "‰ªÖÊûÑÂª∫Ê®°ÂºèÔºåÁâàÊú¨Âè∑: dev-$SHORT_SHA"
              exit 0
            fi

            # Ëé∑ÂèñÊúÄÊñ∞ÁöÑ tag ÁâàÊú¨Âè∑
            LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
            if [ -z "$LATEST_TAG" ]; then
              LATEST_VERSION="0.0.0"
            else
              LATEST_VERSION=${LATEST_TAG#v}
            fi

            # Ëß£Êûê major.minor.patch
            IFS='.' read -r MAJOR MINOR PATCH <<< "$LATEST_VERSION"
            MAJOR=${MAJOR:-0}; MINOR=${MINOR:-0}; PATCH=${PATCH:-0}

            # ÈÄíÂ¢ûÁâàÊú¨Âè∑
            case "$BUMP" in
              major) MAJOR=$((MAJOR + 1)); MINOR=0; PATCH=0 ;;
              minor) MINOR=$((MINOR + 1)); PATCH=0 ;;
              patch) PATCH=$((PATCH + 1)) ;;
            esac

            VERSION="${MAJOR}.${MINOR}.${PATCH}"
            TAG_NAME="v${VERSION}"

            echo "ÁâàÊú¨ÈÄíÂ¢û: $LATEST_TAG -> $TAG_NAME ($BUMP)"

            # ‰ªÖÂàõÂª∫Êú¨Âú∞ tagÔºàÁî®‰∫é changelog ÁîüÊàêÔºâÔºå‰∏çÊé®ÈÄÅÂà∞ËøúÁ®ã
            # tag Â∞ÜÁî± release job ‰∏≠ÁöÑ softprops/action-gh-release ÂàõÂª∫
            # ËøôÊ†∑ target_commitish ÊâçËÉΩÊ≠£Á°ÆÂÖ≥ËÅîÂà∞Ëß¶ÂèëÊûÑÂª∫ÁöÑÂàÜÊîØ
            git tag "$TAG_NAME"
            echo "Êú¨Âú∞ Tag $TAG_NAME Â∑≤ÂàõÂª∫ÔºàÂ∞ÜÁî± release job Êé®ÈÄÅÔºâ"
          fi

          echo "tag=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Tag: $TAG_NAME, Version: $VERSION"

      - name: Get changelog
        if: steps.version.outputs.tag != ''
        id: changelog
        shell: bash
        run: |
          CURRENT_TAG="${{ steps.version.outputs.tag }}"

          # Ëé∑ÂèñÂΩìÂâç tag ÁöÑ‰∏ä‰∏Ä‰∏™ tag
          PREV_TAG=$(git describe --tags --abbrev=0 "${CURRENT_TAG}^" 2>/dev/null || echo "")

          if [ -z "$PREV_TAG" ]; then
            COMMITS=$(git log --pretty=format:"%s" -20 "${CURRENT_TAG}")
          else
            COMMITS=$(git log --pretty=format:"%s" "${PREV_TAG}..${CURRENT_TAG}")
          fi

          # Êåâ commit message ÂâçÁºÄÂàÜÁ±ª
          FEAT=""
          FIX=""
          PERF=""
          OTHER=""

          while IFS= read -r line; do
            [ -z "$line" ] && continue
            # ÂåπÈÖçÂ∏∏ËßÅÂâçÁºÄÔºà‰∏≠Ëã±ÊñáÔºâ
            if echo "$line" | grep -qiE '^(feat|Êñ∞Â¢û|Ê∑ªÂä†|add|Êñ∞ÂäüËÉΩ)'; then
              FEAT="${FEAT}- ${line}\n"
            elif echo "$line" | grep -qiE '^(fix|‰øÆÂ§ç|‰øÆÊ≠£|bugfix)'; then
              FIX="${FIX}- ${line}\n"
            elif echo "$line" | grep -qiE '^(perf|‰ºòÂåñ|refactor|ÈáçÊûÑ|ÊîπËøõ|improve|chore|update|ÂçáÁ∫ß)'; then
              PERF="${PERF}- ${line}\n"
            else
              OTHER="${OTHER}- ${line}\n"
            fi
          done <<< "$COMMITS"

          # ÁªÑË£ÖÂàÜÁ±ªÂêéÁöÑ changelog
          {
            if [ -n "$FEAT" ]; then
              echo "### ‚ú® Êñ∞ÂäüËÉΩ"
              echo ""
              echo -e "$FEAT"
            fi
            if [ -n "$FIX" ]; then
              echo "### üêõ ‰øÆÂ§ç"
              echo ""
              echo -e "$FIX"
            fi
            if [ -n "$PERF" ]; then
              echo "### üîß ‰ºòÂåñ‰∏éÈáçÊûÑ"
              echo ""
              echo -e "$PERF"
            fi
            if [ -n "$OTHER" ]; then
              echo "### üì¶ ÂÖ∂‰ªñ"
              echo ""
              echo -e "$OTHER"
            fi
          } > changelog.txt

          # Â¶ÇÊûúÂàÜÁ±ªÂêé‰∏∫Á©∫ÔºàÊó† commitÔºâÔºåÂÜôÂÖ•ÈªòËÆ§ÂÜÖÂÆπ
          if [ ! -s changelog.txt ]; then
            echo "- Initial release" > changelog.txt
          fi

          echo "Generated changelog (${PREV_TAG:-beginning}..${CURRENT_TAG}):"
          cat changelog.txt

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@1.93.0

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri
        continue-on-error: true

      - name: Install Node dependencies
        run: npm ci

      - name: Download FFmpeg
        shell: pwsh
        run: |
          $ffmpegUrl = "https://www.gyan.dev/ffmpeg/builds/ffmpeg-git-full.7z"
          $ffmpegArchive = "ffmpeg.7z"
          $ffmpegTemp = "ffmpeg-temp"

          Write-Host "Downloading FFmpeg..."
          Invoke-WebRequest -Uri $ffmpegUrl -OutFile $ffmpegArchive

          Write-Host "Extracting FFmpeg (full)..."
          $sevenZip = (Get-Command 7z -ErrorAction SilentlyContinue).Source
          if (-not $sevenZip) {
            throw "7z not found in PATH"
          }
          New-Item -ItemType Directory -Path "$ffmpegTemp" -Force | Out-Null
          & $sevenZip x "-o$ffmpegTemp" "-y" "$ffmpegArchive" | Out-Host

          # Find the extracted folder and move binaries
          $extractedDir = Get-ChildItem -Path "$ffmpegTemp" -Directory | Select-Object -First 1
          New-Item -ItemType Directory -Path "ffmpeg" -Force | Out-Null

          Copy-Item "$($extractedDir.FullName)/bin/ffmpeg.exe" "ffmpeg/"
          Copy-Item "$($extractedDir.FullName)/bin/ffprobe.exe" "ffmpeg/"

          # Cleanup
          Remove-Item "$ffmpegArchive" -Force
          Remove-Item "$ffmpegTemp" -Recurse -Force

          Write-Host "FFmpeg ready:"
          Get-ChildItem "ffmpeg"

      - name: Download fpcalc (Chromaprint)
        shell: pwsh
        run: |
          $fpcalcUrl = "https://github.com/acoustid/chromaprint/releases/download/v1.6.0/chromaprint-fpcalc-1.6.0-windows-x86_64.zip"
          $fpcalcZip = "fpcalc.zip"

          Write-Host "Downloading fpcalc..."
          Invoke-WebRequest -Uri $fpcalcUrl -OutFile $fpcalcZip

          Write-Host "Extracting fpcalc..."
          Expand-Archive -Path $fpcalcZip -DestinationPath "fpcalc-temp" -Force

          # Find and copy fpcalc.exe
          $fpcalcExe = Get-ChildItem -Path "fpcalc-temp" -Recurse -Filter "fpcalc.exe" | Select-Object -First 1
          Copy-Item $fpcalcExe.FullName "ffmpeg\"

          # Cleanup
          Remove-Item $fpcalcZip -Force
          Remove-Item "fpcalc-temp" -Recurse -Force

          Write-Host "fpcalc ready:"
          Get-ChildItem "ffmpeg"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12.9'

      - name: Build audio-separator package
        shell: pwsh
        run: |
          Write-Host "Creating Python virtual environment..."
          python -m venv tools\venv

          Write-Host "Installing PyTorch CUDA 12.8 (required by audio-separator for GPU acceleration)..."
          .\tools\venv\Scripts\pip.exe install torch==2.10.0 torchvision==0.25.0 --index-url https://download.pytorch.org/whl/cu128

          Write-Host "Installing ONNX Runtime GPU with CUDA runtime..."
          .\tools\venv\Scripts\pip.exe install "onnxruntime-gpu[cuda,cudnn]==1.22.0"

          Write-Host "Installing audio-separator and PyInstaller..."
          .\tools\venv\Scripts\pip.exe install audio-separator==0.41.1 pyinstaller==6.13.0

          Write-Host "Building audio-separator executable..."
          .\tools\venv\Scripts\python.exe .\scripts\build_audio_separator.py

          Write-Host "audio-separator package ready:"
          Get-ChildItem "src-tauri\resources\audio-separator" -ErrorAction SilentlyContinue

      - name: Download MDX-Net model and config files
        shell: pwsh
        run: |
          $modelDir = "models\audio-separator\mdx-inst-hq3"
          $modelFile = "UVR-MDX-NET-Inst_HQ_3.onnx"
          $modelUrl = "https://github.com/TRvlvr/model_repo/releases/download/all_public_uvr_models/$modelFile"
          $dataUrlPrefix = "https://raw.githubusercontent.com/TRvlvr/application_data/main"

          Write-Host "Creating model directory..."
          New-Item -ItemType Directory -Path $modelDir -Force | Out-Null

          Write-Host "Downloading MDX-Net model ($modelFile)..."
          Invoke-WebRequest -Uri $modelUrl -OutFile "$modelDir\$modelFile"

          Write-Host "Downloading model config files..."
          Invoke-WebRequest -Uri "$dataUrlPrefix/mdx_model_data/model_data_new.json" -OutFile "$modelDir\mdx_model_data.json"
          Invoke-WebRequest -Uri "$dataUrlPrefix/vr_model_data/model_data_new.json" -OutFile "$modelDir\vr_model_data.json"
          Invoke-WebRequest -Uri "$dataUrlPrefix/filelists/download_checks.json" -OutFile "$modelDir\download_checks.json"

          Write-Host "Model and config files downloaded:"
          Get-ChildItem $modelDir

      - name: Build Tauri application
        shell: pwsh
        run: |
          $env:PATH = "$PWD\ffmpeg;$env:PATH"
          npm run tauri:build

      - name: Create FFmpeg Package
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.version }}"
          $outputDir = "dist/MusicCut-FFmpeg"
          $archiveName = "MusicCut_${version}_x64_FFmpeg.7z"
          $outputFolder = Split-Path -Leaf $outputDir

          Write-Host "Creating FFmpeg package..."

          # Create output directory
          New-Item -ItemType Directory -Path "$outputDir" -Force | Out-Null

          # Copy main exe
          Copy-Item "src-tauri/target/release/MusicCut.exe" "$outputDir"

          # Copy WebView2Loader.dll if exists
          if (Test-Path "src-tauri/target/release/WebView2Loader.dll") {
            Copy-Item "src-tauri/target/release/WebView2Loader.dll" "$outputDir"
          }

          # Copy FFmpeg
          Copy-Item -Recurse "ffmpeg" "$outputDir/ffmpeg"

          # Copy models if exist
          if (Test-Path "models") {
            Copy-Item -Recurse "models" "$outputDir/models"
          }

          # Copy audio-separator
          if (Test-Path "src-tauri/resources/audio-separator") {
            Copy-Item -Recurse "src-tauri/resources/audio-separator" "$outputDir/audio-separator"
          }

          # Create 7z split archive (1900MB per volume to stay under GitHub's 2GB limit)
          Push-Location "dist"
          7z a -t7z -mx=9 -v1900m "$archiveName" "$outputFolder"
          Pop-Location

          Write-Host "FFmpeg package created (split volumes):"
          Get-ChildItem "dist/MusicCut_*_x64_FFmpeg.7z*"

      - name: Create NoFFmpeg Package
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.version }}"
          $outputDir = "dist/MusicCut-NoFFmpeg"
          $archiveName = "MusicCut_${version}_x64_NoFFmpeg.7z"
          $outputFolder = Split-Path -Leaf $outputDir

          Write-Host "Creating NoFFmpeg package..."

          # Create output directory
          New-Item -ItemType Directory -Path "$outputDir" -Force | Out-Null

          # Copy main exe
          Copy-Item "src-tauri/target/release/MusicCut.exe" "$outputDir"

          # Copy WebView2Loader.dll if exists
          if (Test-Path "src-tauri/target/release/WebView2Loader.dll") {
            Copy-Item "src-tauri/target/release/WebView2Loader.dll" "$outputDir"
          }

          # Copy models if exist
          if (Test-Path "models") {
            Copy-Item -Recurse "models" "$outputDir/models"
          }

          # Copy audio-separator
          if (Test-Path "src-tauri/resources/audio-separator") {
            Copy-Item -Recurse "src-tauri/resources/audio-separator" "$outputDir/audio-separator"
          }

          # Create 7z split archive (1900MB per volume to stay under GitHub's 2GB limit)
          Push-Location "dist"
          7z a -t7z -mx=9 -v1900m "$archiveName" "$outputFolder"
          Pop-Location

          Write-Host "NoFFmpeg package created (split volumes):"
          Get-ChildItem "dist/MusicCut_*_x64_NoFFmpeg.7z*"

      - name: List artifacts
        shell: pwsh
        run: |
          Write-Host "=== Build Artifacts ==="
          Get-ChildItem "dist\*.7z*" | ForEach-Object {
            $sizeMB = [math]::Round($_.Length / 1MB, 2)
            Write-Host "$($_.Name) - $sizeMB MB"
          }

      - name: Upload FFmpeg Package
        uses: actions/upload-artifact@v4
        with:
          name: MusicCut_${{ steps.version.outputs.version }}_x64_FFmpeg
          path: dist/MusicCut_${{ steps.version.outputs.version }}_x64_FFmpeg.7z*
          compression-level: 0
          retention-days: 30

      - name: Upload NoFFmpeg Package
        uses: actions/upload-artifact@v4
        with:
          name: MusicCut_${{ steps.version.outputs.version }}_x64_NoFFmpeg
          path: dist/MusicCut_${{ steps.version.outputs.version }}_x64_NoFFmpeg.7z*
          compression-level: 0
          retention-days: 30

      - name: Upload changelog
        uses: actions/upload-artifact@v4
        with:
          name: changelog
          path: changelog.txt
          retention-days: 1

  release:
    needs: build
    if: needs.build.outputs.create_release == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Read changelog
        id: changelog
        run: |
          if [ -f "artifacts/changelog/changelog.txt" ]; then
            CHANGELOG=$(cat artifacts/changelog/changelog.txt)
          else
            CHANGELOG="- Initial release"
          fi
          # ‰ΩøÁî® EOF Â§ÑÁêÜÂ§öË°å
          echo "content<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Calculate artifact sizes
        id: sizes
        run: |
          echo "=== Downloaded Artifacts ==="
          find artifacts -type f

          # ËÆ°ÁÆó FFmpeg ÂåÖÊÄªÂ§ßÂ∞è
          FFMPEG_SIZE=0
          for f in $(find artifacts -type f -name "*FFmpeg.7z*" ! -name "*NoFFmpeg*"); do
            s=$(stat --format="%s" "$f")
            FFMPEG_SIZE=$((FFMPEG_SIZE + s))
          done
          FFMPEG_MB=$(awk "BEGIN {printf \"%.1f\", $FFMPEG_SIZE / 1048576}")
          FFMPEG_PARTS=$(find artifacts -type f -name "*FFmpeg.7z*" ! -name "*NoFFmpeg*" | wc -l)

          # ËÆ°ÁÆó NoFFmpeg ÂåÖÊÄªÂ§ßÂ∞è
          NOFFMPEG_SIZE=0
          for f in $(find artifacts -type f -name "*NoFFmpeg.7z*"); do
            s=$(stat --format="%s" "$f")
            NOFFMPEG_SIZE=$((NOFFMPEG_SIZE + s))
          done
          NOFFMPEG_MB=$(awk "BEGIN {printf \"%.1f\", $NOFFMPEG_SIZE / 1048576}")
          NOFFMPEG_PARTS=$(find artifacts -type f -name "*NoFFmpeg.7z*" | wc -l)

          echo "ffmpeg_size=${FFMPEG_MB} MB" >> $GITHUB_OUTPUT
          echo "ffmpeg_parts=${FFMPEG_PARTS}" >> $GITHUB_OUTPUT
          echo "noffmpeg_size=${NOFFMPEG_MB} MB" >> $GITHUB_OUTPUT
          echo "noffmpeg_parts=${NOFFMPEG_PARTS}" >> $GITHUB_OUTPUT

          echo "FFmpeg: ${FFMPEG_MB} MB (${FFMPEG_PARTS} parts)"
          echo "NoFFmpeg: ${NOFFMPEG_MB} MB (${NOFFMPEG_PARTS} parts)"

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.build.outputs.tag }}
          target_commitish: ${{ github.sha }}
          name: "üéµ MusicCut ${{ needs.build.outputs.tag }}"
          body: |
            ![Windows](https://img.shields.io/badge/platform-Windows_x64-0078D4?logo=windows&logoColor=white)
            ![Version](https://img.shields.io/badge/version-${{ needs.build.outputs.version }}-brightgreen)
            ![Tauri](https://img.shields.io/badge/Tauri-2-FFC131?logo=tauri&logoColor=white)

            ---

            ## üìã Êõ¥Êñ∞Êó•Âøó

            ${{ steps.changelog.outputs.content }}

            ---

            ## üì• ‰∏ãËΩΩËØ¥Êòé

            | ÁâàÊú¨ | ËØ¥Êòé | Â§ßÂ∞è | ÂàÜÂç∑Êï∞ | ÈÄÇÁî®Âú∫ÊôØ |
            |:---:|:---|:---:|:---:|:---|
            | **üü¢ FFmpeg ÂÆåÊï¥Áâà** | ÂåÖÂê´ FFmpeg + fpcalc | `${{ steps.sizes.outputs.ffmpeg_size }}` | ${{ steps.sizes.outputs.ffmpeg_parts }} | ‚úÖ **Êé®ËçêÂ§ßÂ§öÊï∞Áî®Êà∑** |
            | **üîµ NoFFmpeg Á≤æÁÆÄÁâà** | ‰∏çÂê´ FFmpegÔºàÈúÄËá™Ë°åÂÆâË£ÖÔºâ | `${{ steps.sizes.outputs.noffmpeg_size }}` | ${{ steps.sizes.outputs.noffmpeg_parts }} | Â∑≤ÂÆâË£Ö FFmpeg ÁöÑÁî®Êà∑ |

            ## üöÄ Âø´ÈÄüÂºÄÂßã

            1. ‰∏ãËΩΩÂØπÂ∫îÁâàÊú¨ÁöÑ **ÊâÄÊúâ** `.7z.001`„ÄÅ`.7z.002`... ÂàÜÂç∑Êñá‰ª∂
            2. Â∞ÜÊâÄÊúâÂàÜÂç∑ÊîæÂú®Âêå‰∏ÄÁõÆÂΩïÔºåËß£Âéã `.001` Êñá‰ª∂Âç≥ÂèØËá™Âä®ÂêàÂπ∂
            3. ËøêË°å `MusicCut.exe`

            > ‚ö†Ô∏è **ÈáçË¶ÅÊèêÁ§∫**Ôºö‰∏§‰∏™ÁâàÊú¨Âùá‰∏∫ÂàÜÂç∑ÂéãÁº©ÔºåËØ∑Âä°ÂøÖ‰∏ãËΩΩÂêå‰∏ÄÁâàÊú¨ÁöÑÊâÄÊúâÂàÜÂç∑Êñá‰ª∂ÂêéÂÜçËß£Âéã„ÄÇ

            <details>
            <summary>üìñ NoFFmpeg ÁâàÊú¨ÈÖçÁΩÆÊåáÂçó</summary>

            NoFFmpeg ÁâàÊú¨ÈúÄË¶ÅËá™Ë°åÂÆâË£Ö‰ª•‰∏ãÁªÑ‰ª∂Ôºö

            | ÁªÑ‰ª∂ | ‰∏ãËΩΩÂú∞ÂùÄ |
            |:---|:---|
            | FFmpegÔºàÂê´ ffprobeÔºâ | [gyan.dev/ffmpeg](https://www.gyan.dev/ffmpeg/builds/) |
            | fpcalc (Chromaprint) | [acoustid.org/chromaprint](https://acoustid.org/chromaprint) |

            Â∞Ü `ffmpeg.exe`„ÄÅ`ffprobe.exe`„ÄÅ`fpcalc.exe` ÊîæÂÖ•Á®ãÂ∫èÁõÆÂΩïÁöÑ `ffmpeg` Êñá‰ª∂Â§πÔºåÊàñÊ∑ªÂä†Âà∞Á≥ªÁªü PATH„ÄÇ

            </details>
          files: |
            artifacts/**/*.7z*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
