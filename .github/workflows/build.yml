name: Build Windows Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.0.0)'
        required: false
        default: '1.0.0'

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ·ï¸ Get version
        id: version
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "push" ]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            VERSION=${{ github.event.inputs.version || '1.0.0' }}
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: ğŸ“— Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: ğŸ¦€ Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: ğŸ”§ Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri
        continue-on-error: true

      - name: ğŸ“¦ Install Node dependencies
        run: npm ci

      - name: ğŸ¬ Download FFmpeg
        shell: pwsh
        run: |
          $ffmpegUrl = "https://www.gyan.dev/ffmpeg/builds/ffmpeg-release-essentials.zip"
          $ffmpegZip = "ffmpeg.zip"

          Write-Host "Downloading FFmpeg..."
          Invoke-WebRequest -Uri $ffmpegUrl -OutFile $ffmpegZip

          Write-Host "Extracting FFmpeg..."
          Expand-Archive -Path $ffmpegZip -DestinationPath "ffmpeg-temp" -Force

          # Find the extracted folder and move binaries
          $extractedDir = Get-ChildItem -Path "ffmpeg-temp" -Directory | Select-Object -First 1
          New-Item -ItemType Directory -Path "ffmpeg" -Force | Out-Null

          Copy-Item "$($extractedDir.FullName)\bin\ffmpeg.exe" "ffmpeg\"
          Copy-Item "$($extractedDir.FullName)\bin\ffprobe.exe" "ffmpeg\"

          # Cleanup
          Remove-Item $ffmpegZip -Force
          Remove-Item "ffmpeg-temp" -Recurse -Force

          Write-Host "FFmpeg ready:"
          Get-ChildItem "ffmpeg"

      - name: ğŸµ Download fpcalc (Chromaprint)
        shell: pwsh
        run: |
          $fpcalcUrl = "https://github.com/acoustid/chromaprint/releases/download/v1.6.0/chromaprint-fpcalc-1.6.0-windows-x86_64.zip"
          $fpcalcZip = "fpcalc.zip"

          Write-Host "Downloading fpcalc..."
          Invoke-WebRequest -Uri $fpcalcUrl -OutFile $fpcalcZip

          Write-Host "Extracting fpcalc..."
          Expand-Archive -Path $fpcalcZip -DestinationPath "fpcalc-temp" -Force

          # Find and copy fpcalc.exe
          $fpcalcExe = Get-ChildItem -Path "fpcalc-temp" -Recurse -Filter "fpcalc.exe" | Select-Object -First 1
          Copy-Item $fpcalcExe.FullName "ffmpeg\"

          # Cleanup
          Remove-Item $fpcalcZip -Force
          Remove-Item "fpcalc-temp" -Recurse -Force

          Write-Host "fpcalc ready:"
          Get-ChildItem "ffmpeg"

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12.9'

      - name: ğŸ¤– Build audio-separator package
        shell: pwsh
        run: |
          Write-Host "Creating Python virtual environment..."
          python -m venv tools\venv

          Write-Host "Installing ONNX Runtime GPU..."
          .\tools\venv\Scripts\pip.exe install onnxruntime-gpu

          Write-Host "Installing audio-separator (ONNX only, no PyTorch)..."
          .\tools\venv\Scripts\pip.exe install audio-separator pyinstaller

          Write-Host "Building audio-separator executable..."
          .\tools\venv\Scripts\python.exe .\scripts\build_audio_separator.py

          Write-Host "audio-separator package ready:"
          Get-ChildItem "src-tauri\resources\audio-separator" -ErrorAction SilentlyContinue

      - name: ğŸ“¥ Download MDX-Net model and config files
        shell: pwsh
        run: |
          $modelDir = "models\audio-separator\mdx-inst-hq3"
          $modelFile = "UVR-MDX-NET-Inst_HQ_3.onnx"
          $modelUrl = "https://github.com/TRvlvr/model_repo/releases/download/all_public_uvr_models/$modelFile"
          $dataUrlPrefix = "https://raw.githubusercontent.com/TRvlvr/application_data/main"

          Write-Host "Creating model directory..."
          New-Item -ItemType Directory -Path $modelDir -Force | Out-Null

          Write-Host "Downloading MDX-Net model ($modelFile)..."
          Invoke-WebRequest -Uri $modelUrl -OutFile "$modelDir\$modelFile"

          Write-Host "Downloading model config files..."
          Invoke-WebRequest -Uri "$dataUrlPrefix/mdx_model_data/model_data_new.json" -OutFile "$modelDir\mdx_model_data.json"
          Invoke-WebRequest -Uri "$dataUrlPrefix/vr_model_data/model_data_new.json" -OutFile "$modelDir\vr_model_data.json"
          Invoke-WebRequest -Uri "$dataUrlPrefix/filelists/download_checks.json" -OutFile "$modelDir\download_checks.json"

          Write-Host "Model and config files downloaded:"
          Get-ChildItem $modelDir

      - name: ğŸ”¨ Build Tauri application
        shell: pwsh
        run: |
          $env:PATH = "$PWD\ffmpeg;$env:PATH"
          npm run tauri:build

      - name: ğŸ“¦ Create Full Package (with FFmpeg)
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.version }}"
          $outputDir = "dist\MusicCut-Full"
          $archiveName = "MusicCut_${version}_x64_Full.7z"

          Write-Host "Creating full package..."

          # Create output directory
          New-Item -ItemType Directory -Path $outputDir -Force | Out-Null

          # Copy main exe
          Copy-Item "src-tauri\target\release\MusicCut.exe" $outputDir

          # Copy WebView2Loader.dll if exists
          if (Test-Path "src-tauri\target\release\WebView2Loader.dll") {
            Copy-Item "src-tauri\target\release\WebView2Loader.dll" $outputDir
          }

          # Copy FFmpeg
          Copy-Item -Recurse "ffmpeg" "$outputDir\ffmpeg"

          # Copy models if exist
          if (Test-Path "models") {
            Copy-Item -Recurse "models" "$outputDir\models"
          }

          # Copy audio-separator
          if (Test-Path "src-tauri\resources\audio-separator") {
            Copy-Item -Recurse "src-tauri\resources\audio-separator" "$outputDir\audio-separator"
          }

          # Create 7z archive
          7z a -t7z -mx=9 "dist\$archiveName" "$outputDir\*"

          Write-Host "Full package created: dist\$archiveName"
          Get-ChildItem "dist\*.7z"

      - name: ğŸ“¦ Create Lite Package (without FFmpeg)
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.version }}"
          $outputDir = "dist\MusicCut-Lite"
          $archiveName = "MusicCut_${version}_x64_Lite.7z"

          Write-Host "Creating lite package (without FFmpeg)..."

          # Create output directory
          New-Item -ItemType Directory -Path $outputDir -Force | Out-Null

          # Copy main exe
          Copy-Item "src-tauri\target\release\MusicCut.exe" $outputDir

          # Copy WebView2Loader.dll if exists
          if (Test-Path "src-tauri\target\release\WebView2Loader.dll") {
            Copy-Item "src-tauri\target\release\WebView2Loader.dll" $outputDir
          }

          # Copy models if exist
          if (Test-Path "models") {
            Copy-Item -Recurse "models" "$outputDir\models"
          }

          # Copy audio-separator
          if (Test-Path "src-tauri\resources\audio-separator") {
            Copy-Item -Recurse "src-tauri\resources\audio-separator" "$outputDir\audio-separator"
          }

          # Create README for lite version
          'MusicCut Lite ç‰ˆæœ¬
          ==================

          æ­¤ç‰ˆæœ¬ä¸åŒ…å« FFmpegï¼Œéœ€è¦ç”¨æˆ·è‡ªè¡Œå®‰è£…ã€‚

          å®‰è£… FFmpeg:
          1. ä¸‹è½½ FFmpeg: https://www.gyan.dev/ffmpeg/builds/
          2. ä¸‹è½½ fpcalc: https://acoustid.org/chromaprint
          3. å°† ffmpeg.exe, ffprobe.exe, fpcalc.exe æ”¾å…¥ç¨‹åºç›®å½•ä¸‹çš„ ffmpeg æ–‡ä»¶å¤¹

          æˆ–è€…å°† FFmpeg æ·»åŠ åˆ°ç³»ç»Ÿ PATH ç¯å¢ƒå˜é‡ã€‚
          ' | Out-File -FilePath "$outputDir\README-Lite.txt" -Encoding UTF8

          # Create 7z archive
          7z a -t7z -mx=9 "dist\$archiveName" "$outputDir\*"

          Write-Host "Lite package created: dist\$archiveName"
          Get-ChildItem "dist\*.7z"

      - name: ğŸ“‹ List artifacts
        shell: pwsh
        run: |
          Write-Host "=== Build Artifacts ==="
          Get-ChildItem "dist\*.7z" | ForEach-Object {
            $sizeMB = [math]::Round($_.Length / 1MB, 2)
            Write-Host "$($_.Name) - $sizeMB MB"
          }

      - name: ğŸ“¤ Upload Full Package
        uses: actions/upload-artifact@v4
        with:
          name: MusicCut_${{ steps.version.outputs.version }}_x64_Full.7z
          path: dist/*_Full.7z
          compression-level: 0
          retention-days: 30

      - name: ğŸ“¤ Upload Lite Package
        uses: actions/upload-artifact@v4
        with:
          name: MusicCut_${{ steps.version.outputs.version }}_x64_Lite.7z
          path: dist/*_Lite.7z
          compression-level: 0
          retention-days: 30

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: ğŸ“¥ Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: ğŸ“‹ List downloaded artifacts
        run: |
          echo "=== Downloaded Artifacts ==="
          find artifacts -type f -name "*.7z" | while read f; do
            size=$(du -h "$f" | cut -f1)
            echo "$(basename $f) - $size"
          done

      - name: ğŸš€ Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: MusicCut ${{ github.ref_name }}
          body: |
            ## ğŸ“¦ ä¸‹è½½è¯´æ˜

            | ç‰ˆæœ¬ | è¯´æ˜ | é€‚ç”¨åœºæ™¯ |
            |:---:|:---|:---|
            | **Full** | å®Œæ•´ç‰ˆï¼ŒåŒ…å«æ‰€æœ‰ä¾èµ– | æ¨èå¤§å¤šæ•°ç”¨æˆ·ä½¿ç”¨ |
            | **Lite** | ç²¾ç®€ç‰ˆï¼Œä¸å« FFmpeg | å·²å®‰è£… FFmpeg çš„ç”¨æˆ· |

            ## ğŸš€ ä½¿ç”¨æ–¹æ³•

            1. ä¸‹è½½å¯¹åº”ç‰ˆæœ¬çš„ `.7z` æ–‡ä»¶
            2. è§£å‹åˆ°ä»»æ„ç›®å½•
            3. è¿è¡Œ `MusicCut.exe`

            ## âš ï¸ Lite ç‰ˆæœ¬æ³¨æ„

            Lite ç‰ˆæœ¬éœ€è¦è‡ªè¡Œå®‰è£… FFmpegï¼š
            - ä¸‹è½½ [FFmpeg](https://www.gyan.dev/ffmpeg/builds/)
            - ä¸‹è½½ [fpcalc](https://acoustid.org/chromaprint)
            - å°†å¯æ‰§è¡Œæ–‡ä»¶æ”¾å…¥ç¨‹åºç›®å½•çš„ `ffmpeg` æ–‡ä»¶å¤¹
          files: |
            artifacts/**/*.7z
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
